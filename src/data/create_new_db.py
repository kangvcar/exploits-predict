"""
Script for first create new internal database.
"""
from datetime import datetime
from dateutil.parser import parse
from src.db import InternalDB
from dotenv import load_dotenv

load_dotenv()  # env existing in the system are not overwritten


PATH_DB_SCHEMA_FILE = "src/data/db_schema.sql"


def create_new_empty_db(start_update_datetime):
    """
    start_update_datetime (str): manual set first lastModifiedDate
    (for download cve/exploits only later) parse("2023-02-15 17:12:33")
    """
    previous_modified = parse(start_update_datetime)

    db_new = InternalDB(pull=False)

    # initial create database schema

    db_new.safe_executescript(sql_script_fname=PATH_DB_SCHEMA_FILE, verbose=True)

    sql_query = (
        """
        INSERT INTO dbupdate_stats(script_run_date, cve_lastModified, exploit_modified)
        VALUES (?, ?, ?);
        """,
        (datetime.now(), previous_modified, previous_modified),
    )
    db_new.safe_write_query(*sql_query)

    db_new.print_db_schema()

    # push db to remote server
    db_new.db_push()


if __name__ == "__main__":
    confirm = input(
        "Attention! Are you sure you want to create a new empty database?\n\
        Type 'yes' to confirm or anything to cancel: "
    )
    if confirm == "yes":
        start_date = input(
            "Enter start update date for download cve/exploits only later\n\
            (ex. 2023-02-15 17:12:33):"
        )
        create_new_empty_db(start_date)
